import isLocalDev from '../../utils/isLocalDev';
import React, { createContext, useCallback, useEffect, useState } from 'react';
import AuthProvider from '../../auth/contexts/AuthProvider';
import { bridgeServiceObservable, onConnectObservable, initBridgeService, postMessage as postMessageService, } from '../../services/bridge-service';
var defaultValue = {
    postMessage: function () {
        throw new Error('postMessage must be defined!');
    },
    onGetMessage: function () {
        throw new Error('onGetMessage must be defined!');
    },
    simulateIFrameMessage: function () {
        throw new Error('simulateIFrameMessage must be defined!');
    }
};
export var NearSocialBridgeContext = createContext(defaultValue);
/**
 * Provides the Near Social Bridge features.
 *
 * Fallback component is displayed (if provided) until the connection is established with the Widget
 * @returns
 */
var NearSocialBridgeProvider = function (_a) {
    var children = _a.children, fallback = _a.fallback;
    var _b = useState({ cb: function () { } }), _onGetMessage = _b[0], set_onGetMessage = _b[1];
    var _c = useState(false), isConnected = _c[0], setIsConnected = _c[1];
    /**
     * Post Message
     */
    var postMessage = useCallback(function (message) {
        postMessageService(message);
    }, []);
    /**
     * Set the onGetMessage handler
     */
    var onGetMessage = useCallback(function (cb) {
        set_onGetMessage({ cb: cb });
    }, []);
    /**
     * Simulate the iframe's message prop to send a message to the external app
     */
    var simulateIFrameMessage = useCallback(function (message) {
        var _a;
        // NOTE: experimental, should be tested
        (_a = window.top) === null || _a === void 0 ? void 0 : _a.postMessage(message);
    }, []);
    useEffect(function () {
        // Set up the message receiver
        var handler = function (event) {
            if (_onGetMessage.cb && event.type === 'message') {
                _onGetMessage.cb(event);
            }
        };
        bridgeServiceObservable.subscribe(handler);
        // Init Bridge Service
        initBridgeService();
        return function () {
            bridgeServiceObservable.unsubscribe(handler);
        };
    }, [_onGetMessage]);
    // Get to know when the connection is established. The children is going to render after the connection
    useEffect(function () {
        var handler = function () {
            setIsConnected(true);
        };
        onConnectObservable.subscribe(handler);
        return function () {
            onConnectObservable.unsubscribe(handler);
        };
    }, []);
    if (!isConnected && !isLocalDev) {
        if (fallback)
            return React.createElement(React.Fragment, null, fallback);
        return null;
    }
    return (React.createElement(NearSocialBridgeContext.Provider, { value: { postMessage: postMessage, onGetMessage: onGetMessage, simulateIFrameMessage: simulateIFrameMessage } },
        React.createElement(AuthProvider, null, children)));
};
export default NearSocialBridgeProvider;
