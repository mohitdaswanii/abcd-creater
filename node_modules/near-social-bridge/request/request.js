import { initBridgeService, bridgeServiceObservable, postMessage } from '../services/bridge-service';
import isDevelopment from '../utils/isDevelopment';
import isLocalDev from '../utils/isLocalDev';
import { getMockedResponse, globalMock } from './mock';
/**
 * Build a request body
 * @param type Request type to be handled inside the View
 * @param payload Request payload
 * @returns
 */
export var buildRequestBody = function (type, payload) {
    return {
        from: 'external-app',
        type: type,
        payload: payload
    };
};
/**
 * Send a request to the Near Social View
 * @param requestType Request type to be handled inside the View (you can use `buildRequestBody` in order to
 * follow the pattern)
 * @param payload Any payload to be sent to the View
 * @param {forceTryAgain: boolean, timeout: number} options Force the request to re-try every <timeout> (default is 1 second)
 * @returns
 */
var request = function (requestType, payload, options) {
    // Use mock? -> is dev, is local, the "requestType" has a mock
    if (isDevelopment && isLocalDev && globalMock[requestType]) {
        return getMockedResponse(requestType, payload);
    }
    // Go the regular way
    initBridgeService();
    return new Promise(function (resolve, reject) {
        var gotPayload = false;
        var tries = 0;
        // Observe it till get the answer from the View
        var checkMessage = function (e) {
            if (e.data.type === 'answer' && e.data.requestType === requestType) {
                gotPayload = true;
                resolve(e.data.payload);
                bridgeServiceObservable.unsubscribe(checkMessage);
            }
        };
        bridgeServiceObservable.subscribe(checkMessage);
        // Post Message
        var message = buildRequestBody(requestType, payload);
        postMessage(message);
        // Timer to try again
        var checkAndTryAgain = function () {
            setTimeout(function () {
                if (!gotPayload) {
                    if (tries < 10) {
                        tries++;
                        postMessage(message);
                        checkAndTryAgain();
                    }
                    else {
                        reject("the Widget did not send a answer for request of type ".concat(requestType));
                    }
                }
            }, (options === null || options === void 0 ? void 0 : options.timeout) || 1000);
        };
        if (options === null || options === void 0 ? void 0 : options.forceTryAgain) {
            checkAndTryAgain();
        }
    });
};
export default request;
